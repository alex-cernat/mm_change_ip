---
title: "Report_mm_chenge"
author: "Alexandru Cernat"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}

# clear working space
rm(list = ls())



# use local packages on work machine
if (Sys.getenv("USERNAME") == "msassac6") {.libPaths(c(
  paste0(
    "C:/Users/",
    Sys.getenv("USERNAME"),
    "/Dropbox (The University of Manchester)/R/package"
  ),
  .libPaths()[-1]
))}


# use packrat to install packages localy

pkg <- c("tidyverse",  "haven", "lavaan", "MplusAutomation", "nnet",
         "knitr", "texreg", "pander")

sapply(pkg, library, character.only = T)

# load local functions
map(str_c("./functions/",
          list.files("./functions/")),
    source)



# Import data -------------------------------------------------------------

load("./data/out/identifier_vars_data_charlotte.RData")
load("./data/out/overlap_vars_data_charlotte.RData")


vars_desc <- read_csv("./data/out/vars_desc.csv")

wide_data3 <- read_rds("./data/wide_data3.RDS")
wide_data5 <- read_rds("./data/clean_data.RDS")

fit_tab3 <- read_csv("./output/fit_tab1_mlr.csv")
sig_vars2 <- read_csv("./output/sig_vars.csv")



knitr::opts_chunk$set(echo = F, message = F, warning = F, error = F)
```




## Some descriptives on the variables we selected to analyse

These are the variables we selected after we went through all possible variables available. Add detailed description from Charlotte.

```{r}
cont_vars <- c("finnow", "fiyrdia", "howlng", "netpuse", "scsf1",
               "scsf3a", "scsf3b", "scsf4a", "scsf4b", "scsf5",
               "scsf6a", "scsf6b", "scsf6c", "scsf7")

cat_vars <- c("aidxhh", "caruse", "finfut", "j2has", "jbhas",
              "jbsemp", "jbterm1", "lkmove", "mobuse", "scghqa",
              "scghqb", "scghqc", "scghqd", "scghqe", "scghqf",
              "scghqg", "scghqh", "scghqi", "scghqj", "scghqk",
              "scghql", "scsf2a", "scsf2b", "smoker", "vote1",
              "vote6", "xpmove")


vars_desc %>% 
  select(Code, Label, `Type of Variable`, Wave) %>% 
  mutate(Label = str_to_sentence(Label)) %>% 
  kable()

```

# Models

## Sequence of models

We looked ath 4 models that add increasing restrictions:

1. Base LGM with no differences
2. We restrict the mean of the Slope to be the same across groups
3. We restrict the variance of the slope to be the same
4. We restrict the co-variance between the intercept and slope as well as the variance of the intercept to be the same

We compare two groups:

a. Single versus mixed mode
b. Face to face versus Web (where we create weights for selection)


## Logistic models used for weighting

Here are the models we used to creating the weight:

- Education
- Age (categorical)
- Female
- Having a partner
- General health
- Long time illness
- Live in London
- Live in the North
- Live in urban area
- Refreshment sample

We have 4 patterns depnding when the variables are present:

- all the waves ("all")
- all the waves except wave 9 ("no9")
- waves 5, 6 and 7 ("p567")
- waves 7, 8, 9 and 10 ("p7")

We create weights for each pattern as we also have different respondents selection.

```{r results='asis'}
pred <- c("edu", "agecat", "female", "partner",
          "sf1", "longill", "london", "north",
          "urban", "refresh")

outcomes <- c("all", "no9", "p567", "p7")

reg_out <- map(outcomes, function(x) {
  form <- str_c(x, " ~ ", str_c(pred,
                                      collapse = " + "))

  data <- wide_data3 %>%
    mutate_at(x, as.factor)

  # run logistic
  mod <- glm(form, data, family = binomial(link = 'logit'))

  mod
})
  
reg_lab <- c("Intercept", "Edu: A level", "Edu: GCSE", "Edu: Other",
             "Age: 36-55", "Age: 56:75", "Age: over 75", "Female", 
             "Has partner", "General health", "Long term illness",
             "Lives in London", "Lives in North of UK", "Lives in Urban area",
             "Refreshement sample")

htmlreg(reg_out, html.tag = F, head.tag = F,
        custom.model.names = outcomes,
        custom.coef.names = reg_lab)
```

## Estimation issues

 A total of 328 models were fit (41 variables x 8 models each). We treated variables with less then 5 categories as ordinal in the modeling while those that had more as continious resulting in 14 continious and 27 cetegorical outcomes.  

- eight models failed to converge: all "fiyrdia" models failed to converged and were excluded
- ten models had warnings due to convergence and will be ignored in the analysis: jbsemp_all_cor, jbsemp_all_var, jbsemp_mm_mean, smoker_mm_config, smoker_mm_cor, smoker_mm_var, smoker_p7_cor, smoker_p7_var,  jbsemp_all_mean,
jbsemp_mm_config


- nine models had convergence issues that were fixed by restricting the mean and variance of the inctercept to 0 and increasing the number of iterations: jbsemp_all_config, jbsemp_mm_cor, jbsemp_mm_var, lkmove_mm_var, lkmove_no9_var,
mobuse_mm_var, smoker_mm_mean, smoker_p7_config, smoker_p7_mean, caruse_all_var, caruse_mm_var. For these models we rerun the models in the series (4 model group comparison) with the same options in order to insure comparability.

## Fit models 

Decrease in fit with new models

```{r}
# distribution of delta bic
fit_tab3 %>%
  filter(model != "config") %>%
  filter(dif_bic > 0) %>% # keep only positive delta bic to help reading
  mutate(model2 = as.factor(model),
         model2 = fct_relevel(model2, "mean", "var"),
         model2 = fct_recode(model2, "Mean" = "mean",
                             "Variance" = "var",
                             "Correlation" = "cor")) %>% 
  ggplot(aes(dif_bic)) +
  geom_histogram() +
  facet_wrap( ~ model2, scales = "free") +
  geom_vline(xintercept = 10, color = "red") +
  theme_bw() +
  labs(y = "Count", x = "Difference in BIC",
       caption = "Note change of scales\nDistribution restricted to positive differences\n for ease of reading")

ggsave("./output/BIC_dif.png", dpi = 500)
```

The largest difference is from caruse in the mixed mode comparison.

Out of 228 coefficient comparisons 48 were significant. Always the difference was in the correltion model.

```{r results='asis'}

fit_tab3 %>% 
  mutate(sig_dif = ifelse(dif_bic > 10, 1, 0),
         grp = ifelse(group == "mm", "Mode design", "Mode")) %>% 
  filter(model != "config") %>% 
  count(grp, model, sig_dif) %>% 
  na.omit() %>% 
  mutate(prop = n/sum(n)) %>% 
  kable()
```
  
  
```{r results='asis'}
sig_fit <- fit_tab3 %>% 
  filter(dif_bic > 10)

sig_fit_mm <- sig_fit %>% 
  filter(group == "mm")

sig_fit_mode <- sig_fit %>% 
  filter(group != "mm")

vars_desc <- vars_desc %>% 
  mutate(sig_mm = vars_desc$Code %in% sig_fit_mm$var,
         sig_mode = vars_desc$Code %in% sig_fit_mode$var)

health_labs <- c("Caring", "Smoking", 
                 str_subset(vars_desc$`Topic of Variable - Module`, "Self-"))
work_labs <- c("Household Finance", "Housework", 
               "Second Jobs", "Current Employment")


vars_desc <- vars_desc %>% 
  mutate(topic = 
           case_when(`Topic of Variable - Module` %in% work_labs ~ "Work",
                     `Topic of Variable - Module` %in% health_labs ~ "Health",
                     TRUE ~ `Topic of Variable - Module`),
         topic2 = ifelse(topic == "Health", "Health", "Other"),
         type = ifelse(`Type of Variable` == "binary", 
                       "Binary", "Ordinal/continious")) 



nice_cross <- function(x, y, x_name = "", y_name = "") {
  tab <- table(x_name = x, y_name = y)
  
  tab_prop <- tab %>%
    prop.table(1) %>%
    round(2)
  
  tab_labs <- table(x)
  
  rownames(tab_prop) <- str_c(names(tab_labs), " (", tab_labs, ")")
  names(attributes(tab_prop)$dimnames) <- c(x_name, y_name)
  
  tab_prop
}

```


```{r}
nice_cross(vars_desc$type, vars_desc$sig_mm, 
           x_name = "Type") %>% 
  kable(caption = "Significant mode design")

chisq.test(vars_desc$type, vars_desc$sig_mm)
```


```{r}
nice_cross(vars_desc$type, vars_desc$sig_mode, 
           x_name = "Type", "Significant mode") %>% 
  kable(caption = "Significant mode")
chisq.test(vars_desc$type, vars_desc$sig_mode)


nice_cross(vars_desc$topic2, vars_desc$sig_mm, 
           x_name = "Topic", "Significant mode design") %>% 
  kable(caption = "Significant mode design")
chisq.test(vars_desc$topic2, vars_desc$sig_mm)


nice_cross(vars_desc$topic2, vars_desc$sig_mode, 
           x_name = "Type", "Significant mode") %>% 
  kable(caption = "Significant mode")
chisq.test(vars_desc$topic2, vars_desc$sig_mode)


```



### Show coefficients that are significantly different

Average differences

```{r results='asis'}
# average differences
sig_vars2 %>%
  filter(coef != "s") %>%
  mutate(coef2 = ifelse(coef == "cov", 
                        "Co-variance", "Variance intercept")) %>%
  group_by(grp, coef2, modes) %>%
  summarise(mean(est)) %>%
  ungroup() %>% 
  rename(Comparison = grp, Coeffcient = coef2, Group = modes,
         `Mean difference` = `mean(est)`) %>% 
  kable(digits = 2)
```

Large differences can be found for:

```{r results='asis'}
# largest difference
# biggest differences
sig_vars2 %>%
  filter(coef != "s") %>%
  filter(var %in% c("jbhas", "mobuse")) %>%
  mutate(coef2 = ifelse(coef == "cov", 
                        "Co-variance", "Variance intercept")) %>%
  select(grp, var, coef2, modes, est) %>%
  arrange(grp, var, coef2, modes) %>% 
  ungroup() %>% 
  rename(Comparison = grp, Coeffcient = coef2, Group = modes,
         Estimate = est, Variable = var) %>%
  kable(digits = 2)
```

This is the distribution for the rest of the variables that are significantly different.

```{r fig.height=8.5, fig.width=7.5}
## the rest
sig_vars2 %>%
  filter(coef != "s") %>%
  filter(var != "jbhas") %>% # largest diffence
  filter(var != "mobuse") %>% # largest diffence
  mutate(coef2 = ifelse(coef == "cov", "Co-variance", "Variance intercept"),
         coef2 = as.factor(coef2) %>% 
           fct_rev(),
         modes = as.factor(modes) %>% 
           fct_relevel("Web")) %>%
  ggplot(aes(fct_reorder(var, est), est, color = modes)) +
  geom_point(position = position_dodge(), size = 3, alpha = 0.7) +
  facet_grid(grp ~ coef2, scales = "free") +
  coord_flip() +
  theme_bw() +
  geom_hline(yintercept = 0) +
  labs(y = "Estimates", x = "Variables", color = "Group")

ggsave("./output/dif_coeficients.png", dpi = 500)


```

# Descriptives statistics?

### Descriptives for modes


### Descriptives for variables used in weighting



